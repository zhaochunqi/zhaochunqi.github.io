title: 【2017-12-04】
date: 2017-12-04 3:04 PM
categories: "logbook"
visible: hide
tags: [dev,]

---

### 问题

AKKA Stream 添加 fault tolerance。

需要能够在出现简单问题的时候能够自动重启。出错原因要能够 Push 到 SQS

### 解决方法

参考 AKKA Stream 中的记录的 fault tolerance 的方法来操作。

[https://doc.akka.io/docs/akka/2.5.5/scala/stream/stream-error.html](https://doc.akka.io/docs/akka/2.5.5/scala/stream/stream-error.html)

### 记录解决过程

* 使用 `recover` 方法

    ```java
        .recover(new PFBuilder()
        .match(RuntimeException.class, ex -> "stream truncated")
        .build()
    ```

    这个方法好像不能获取到出错地方的具体信息，比如传入源的信息，这样我就没有办法把日志记录到 SQS 中了。

* 使用 `recoverWithRetries` 方法
    ```java
    .recoverWithRetries(
    1, // max attempts
    new PFBuilder()
        .match(RuntimeException.class, ex -> planB)
        .build()
    ```

    方法同上，问题也同上。

* 使用 `Delayed restarts with a backoff stage`
    
    目前看起来这个有可能靠谱。

    但我还没理解这里面说的具体是什么意思。同时，我查看了这几个链接：

    * [https://stackoverflow.com/questions/23773175/akka-java-fault-tolerance-and-actor-restarting](https://stackoverflow.com/questions/23773175/akka-java-fault-tolerance-and-actor-restarting)

    这个so问答链接里面还是讲解了很多的关于 actor 问题的探讨，值得一看。

    * [http://danielwestheide.com/blog/2013/03/20/the-neophytes-guide-to-scala-part-15-dealing-with-failure-in-actor-systems.html](http://danielwestheide.com/blog/2013/03/20/the-neophytes-guide-to-scala-part-15-dealing-with-failure-in-actor-systems.html)

    根据这个链接处理了 默认的 decider 方法。顺便看了 scala 关于 try catch 的一些特殊处理。 [http://danielwestheide.com/blog/2012/12/26/the-neophytes-guide-to-scala-part-6-error-handling-with-try.html](http://danielwestheide.com/blog/2012/12/26/the-neophytes-guide-to-scala-part-6-error-handling-with-try.html)

    * [https://doc.akka.io/docs/akka/2.3.9/java/untyped-actors.html#Ask__Send-And-Receive-Future](https://doc.akka.io/docs/akka/2.3.9/java/untyped-actors.html#Ask__Send-And-Receive-Future)
    这个链接主要是跟着上文的 SO 链接过来的，没看懂要表达什么。

* 使用 `supervision strategy `

    上面的链接用到了此方法。

### 记录此方法，思考是否有更好的解决方法

最终采用的代码:

```java
final Function<Throwable, Supervision.Directive> decider = exc -> {
    log.error(ExceptionUtils.getStackTrace(exc));
    if(exc instanceof ActorInitializationException){
        return Supervision.stop();
    }

    if(exc instanceof ActorKilledException) {
        return Supervision.stop();
    }

    return Supervision.restart();
};
```

OneForOneStrategy 这种好像在 Akka Stream 上不适用，默认就是 OneForOneStrategy ？